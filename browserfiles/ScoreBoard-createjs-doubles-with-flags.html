<!--
  Copyright 2018 Miguel MÃ¼ller

  This file is part of Shieldbreakers-StreamControl-setup.

  Shieldbreakers-StreamControl-setup is free software: you can redistribute it
  and/or modify it under the terms of the GNU General Public License as
  published by the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  Shieldbreakers-StreamControl-setup is distributed in the hope that it will be
  useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General
  Public License for more details.

  You should have received a copy of the GNU General Public License along with
  Shieldbreakers-StreamControl-setup.  If not, see <http://www.gnu.org/licenses/>.
-->
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <script src="js/easeljs-2017.10.12.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/tweenjs-2017.10.12.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/countries.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/common.js" type="text/javascript" charset="utf-8"></script>
    <script type="text/javascript">
      const flagFolder = "images/GoSquared/cropped/iso/64flat/";
      const flagHeight = 44;
      const flagWidth = 60 * flagHeight / 40;//assuming flag images are 60x40
      const flagAlpha = 0.25
      
      //Fixed size in px for the character icons.
      const char_icon_size = 50;
      const char_icon_fixed_width = false;//if false, height will be fixed instead.

      var timestampOld;
      var timestamp;
      var pName1;
      var pScore1;
      var pName2;
      var pScore2;
      var pChar1;
      var pChar2;
      var pCountry1;
      var pCountry2;
      var oldChar1 = "";
      var oldChar2 = "";
      var oldCountry1 = "";
      var oldCountry2 = "";
      var round;

      var teammateName1;
      var teammateName2;
      var teammateChar1;
      var teammateChar2;
      var oldTeammateChar1 = "";
      var oldTeammateChar2 = "";
      var tpCountry1;
      var tpCountry2;
      var oldtpCountry1 = "";
      var oldtpCountry2 = "";

      var xmlDoc;

      const xhr = new XMLHttpRequest();

      var animating = false;
      var doUpdate = false;

      var stage,board,pName1t,pName2t,tName1t,tName2t,pScore1t,pScore2t,pCountry1b,pCountry2b,pFlag1,pFlag2,tpCountry1b,tpCountry2b,tpFlag1,tpFlag2,pCharIcon1,pCharIcon2,tCharIcon1,tCharIcon2,roundt;

      function init() {

        xhr.overrideMimeType('text/xml');

        var timeout = this.window.setInterval(function() {
          pollHandler();
        }, 250);

        stage = new createjs.Stage("myCanvas");

        board = new createjs.Container();


        scoreboard = new createjs.Bitmap("images/doubles-overlay.png");
        scoreboard.regX = 0;
        scoreboard.regY = 0;

        board.addChild(scoreboard);

        pName1t = new createjs.Text("", "30px Helvetica", "#ffffff");
        pName1t.x = 546;
        pName1t.y = 10;
        pName1t.maxWidth = 348;
        pName1t.textAlign = "center";

        board.addChild(pName1t);

        pName2t = new createjs.Text("", "30px Helvetica", "#ffffff");
        pName2t.x = 1920-pName1t.x;
        pName2t.y = pName1t.y;
        pName2t.maxWidth = pName1t.maxWidth;
        pName2t.textAlign = "center";

        board.addChild(pName2t);
        
        pFlag1 = new createjs.Container();
        pFlag1.x = 326 + 30;
        pFlag1.y = 0;
        pFlag1.alpha=0;

        board.addChild(pFlag1);
        
        tpFlag1 = new createjs.Container();
        tpFlag1.x = 695 - 30;
        tpFlag1.y = pFlag1.y;
        tpFlag1.alpha=0;

        board.addChild(tpFlag1);

        pFlag2 = new createjs.Container()
        pFlag2.x = 1920-flagWidth-tpFlag1.x;
        pFlag2.y = tpFlag1.y;
        pFlag2.alpha=0;

        board.addChild(pFlag2);

        tpFlag2 = new createjs.Container()
        tpFlag2.x = 1920-flagWidth-pFlag1.x;
        tpFlag2.y = pFlag1.y;
        tpFlag2.alpha=0;

        board.addChild(tpFlag2);

        pCharIcon1 = new createjs.Container();
        pCharIcon1.x = 322;
        pCharIcon1.y = 1;
        pCharIcon1.alpha=0;

        board.addChild(pCharIcon1);

        tCharIcon2 = new createjs.Container();
        tCharIcon2.x = 1920-char_icon_size-pCharIcon1.x;
        tCharIcon2.y = pCharIcon1.y;
        tCharIcon2.alpha=0;

        board.addChild(tCharIcon2);

        tCharIcon1 = new createjs.Container();
        tCharIcon1.x = 722;
        tCharIcon1.y = 1;
        tCharIcon1.alpha=0;

        board.addChild(tCharIcon1);

        pCharIcon2 = new createjs.Container();
        pCharIcon2.x = 1920-char_icon_size-tCharIcon1.x;
        pCharIcon2.y = tCharIcon1.y;
        pCharIcon2.alpha=0;

        board.addChild(pCharIcon2);

        pScore1t = new createjs.Text("", "32px Helvetica", "#ffffff");
        pScore1t.x = 814;
        pScore1t.y = 12;
        pScore1t.textAlign = "center";

        board.addChild(pScore1t);

        pScore2t = new createjs.Text("", "32px Helvetica", "#ffffff");
        pScore2t.x = 1920-pScore1t.x;
        pScore2t.y = pScore1t.y;
        pScore2t.textAlign = "center";

        board.addChild(pScore2t);

        roundt = new createjs.Text("", "22px Helvetica", "#ffffff");
        roundt.x = 960;
        roundt.y = 11;
        roundt.maxWidth = 220;
        roundt.textAlign = "center";

        board.addChild(roundt);

        stage.addChild(board);

        board.y = -100;

        createjs.Tween.get(board).to({y:0},800, createjs.Ease.quintOut);

        createjs.Ticker.addEventListener("tick", enterFrame);
        createjs.Ticker.framerate = 60;


        stage.update();
      }


      function enterFrame(event) {
        stage.update(event);
      }

      function pollHandler()
      {
        loadData();
        if (timestamp != timestampOld) {
          doUpdate = true;
        }
        if (!animating && doUpdate) {
          updateBoard();
        }
      }

      function loadData() {
        xhr.open('GET', 'streamcontrol.xml');
        xhr.send();
        xhr.onreadystatechange = function(){
          xmlDoc = xhr.responseXML;

          if (xmlDoc != null) {
            pName1 = getValueFromTag(xmlDoc,'pName1');
            pName2 = getValueFromTag(xmlDoc,'pName2');
            teammateName1 = getValueFromTag(xmlDoc,'teammateName1');
            teammateName2 = getValueFromTag(xmlDoc,'teammateName2');
            pScore1 = getValueFromTag(xmlDoc,'pScore1');
            pScore2 = getValueFromTag(xmlDoc,'pScore2');
            pCountry1 = getCountry(getValueFromTag(xmlDoc,'pCountry1'));
            pCountry2 = getCountry(getValueFromTag(xmlDoc,'pCountry2'));
            tpCountry1 = getCountry(getValueFromTag(xmlDoc,'teammateCountry1'));
            tpCountry2 = getCountry(getValueFromTag(xmlDoc,'teammateCountry2'));
            pChar1 = getSmashChar(getValueFromTag(xmlDoc,'pChar1'));
            pChar2 = getSmashChar(getValueFromTag(xmlDoc,'pChar2'));
            teammateChar1 = getSmashChar(getValueFromTag(xmlDoc,'teammateChar1'));
            teammateChar2 = getSmashChar(getValueFromTag(xmlDoc,'teammateChar2'));
            round = getValueFromTag(xmlDoc,'round');
            timestampOld = timestamp;
            timestamp = getValueFromTag(xmlDoc,'timestamp');
          }
        }
      }

      function updateBoard() {

        if (pName1t.text != pName1 + (teammateName1 == ""?"":(" + " + teammateName1))) {
          animating = true;
          var name1x = pName1t.x;
          createjs.Tween.get(pName1t).to({x:pScore1t.x-86,alpha:0},500, createjs.Ease.quintIn).call(function() {pName1t.text = pName1 + (teammateName1 == ""?"":(" + " + teammateName1));})
            .to({x:name1x,alpha:1},500, createjs.Ease.quintOut).call(function() {animating = false;});
        }

        if (pName2t.text != pName2 + (teammateName2 == ""?"":(" + " + teammateName2))) {
          animating = true;
          var name2x = pName2t.x;
          createjs.Tween.get(pName2t).to({x:pScore2t.x+86,alpha:0},500, createjs.Ease.quintIn).call(function() {pName2t.text = pName2 + (teammateName2 == ""?"":(" + " + teammateName2));})
            .to({x:name2x,alpha:1},500, createjs.Ease.quintOut).call(function() {animating = false;});
        }

        if (pScore1t.text != pScore1) {
          animating = true;
          createjs.Tween.get(pScore1t).to({alpha:0},500, createjs.Ease.quintIn).call(function() {pScore1t.text = pScore1;})
            .to({alpha:1},500, createjs.Ease.quintOut).call(function() {animating = false;});
        }

        if (pScore2t.text != pScore2) {
          animating = true;
          createjs.Tween.get(pScore2t).to({alpha:0},500, createjs.Ease.quintIn).call(function() {pScore2t.text = pScore2;})
            .to({alpha:1},500, createjs.Ease.quintOut).call(function() {animating = false;});
        }

        if (oldCountry1 != pCountry1 || pFlag1.alpha == 0) {
          animating = true;
          var pFlag1n = new createjs.Bitmap(flagFolder + pCountry1 + ".png");

          createjs.Tween.get(pFlag1).to({alpha:0},500, createjs.Ease.quintIn).call(function() {
            pFlag1.removeAllChildren();

            if (pCountry1 != "unknown") { //image exists
              pFlag1n.scaleY = flagHeight / pFlag1n.image.height;
              pFlag1n.scaleX = pFlag1n.scaleY;

              pFlag1.addChild(pFlag1n);
            }
            oldCountry1 = pCountry1;
          })
            .to({alpha:flagAlpha},500, createjs.Ease.quintOut).call(function() {animating = false;});
        }

        if (oldCountry2 != pCountry2 || pFlag2.alpha == 0) {
          animating = true;
          var pFlag2n = new createjs.Bitmap(flagFolder + pCountry2 + ".png");

          createjs.Tween.get(pFlag2).to({alpha:0},500, createjs.Ease.quintIn).call(function() {
            pFlag2.removeAllChildren();

            if (pCountry2 != "unknown") { //image exists
              pFlag2n.scaleY = flagHeight / pFlag2n.image.height;
              pFlag2n.scaleX = pFlag2n.scaleY;

              pFlag2.addChild(pFlag2n);
            }
            oldCountry2 = pCountry2;
          })
            .to({alpha:flagAlpha},500, createjs.Ease.quintOut).call(function() {animating = false;});
        }

        if (oldtpCountry1 != tpCountry1 || tpFlag1.alpha == 0) {
          animating = true;
          var tpFlag1n = new createjs.Bitmap(flagFolder + tpCountry1 + ".png");

          createjs.Tween.get(tpFlag1).to({alpha:0},500, createjs.Ease.quintIn).call(function() {
            tpFlag1.removeAllChildren();

            if (tpCountry1 != "unknown") { //image exists
              tpFlag1n.scaleY = flagHeight / tpFlag1n.image.height;
              tpFlag1n.scaleX = tpFlag1n.scaleY;

              tpFlag1.addChild(tpFlag1n);
            }
            oldtpCountry1 = tpCountry1;
          })
            .to({alpha:flagAlpha},500, createjs.Ease.quintOut).call(function() {animating = false;});
        }

        if (oldtpCountry2 != tpCountry2 || tpFlag2.alpha == 0) {
          animating = true;
          var tpFlag2n = new createjs.Bitmap(flagFolder + tpCountry2 + ".png");

          createjs.Tween.get(tpFlag2).to({alpha:0},500, createjs.Ease.quintIn).call(function() {
            tpFlag2.removeAllChildren();

            if (tpCountry2 != "unknown") { //image exists
              tpFlag2n.scaleY = flagHeight / tpFlag2n.image.height;
              tpFlag2n.scaleX = tpFlag2n.scaleY;

              tpFlag2.addChild(tpFlag2n);
            }
            oldtpCountry2 = tpCountry2;
          })
            .to({alpha:flagAlpha},500, createjs.Ease.quintOut).call(function() {animating = false;});
        }

        if (oldChar1 != pChar1 || pCharIcon1.alpha == 0) {
          animating = true;
          var pCharIcon1n = new createjs.Bitmap("images/smash_ultimate/" + pChar1 + ".png");

          createjs.Tween.get(pCharIcon1).to({alpha:0},500, createjs.Ease.quintIn).call(function() {
            pCharIcon1.removeAllChildren();

            if (pCharIcon1n.image.height != 0) { //image exists
              pCharIcon1n.scaleX = char_icon_size / (char_icon_fixed_width?pCharIcon1n.image.width:pCharIcon1n.image.height);
              pCharIcon1n.scaleY = pCharIcon1n.scaleX;

              pCharIcon1.addChild(pCharIcon1n);
            }
            oldChar1 = pChar1;
          })
            .to({alpha:1},500, createjs.Ease.quintOut).call(function() {animating = false;});
        }

        if (oldChar2 != pChar2 || pCharIcon2.alpha == 0) {
          animating = true;
          var pCharIcon2n = new createjs.Bitmap("images/smash_ultimate/" + pChar2 + ".png");

          createjs.Tween.get(pCharIcon2).to({alpha:0},500, createjs.Ease.quintIn).call(function() {
            pCharIcon2.removeAllChildren();

            if (pCharIcon2n.image.height != 0) { //image exists
              pCharIcon2n.scaleX = char_icon_size / (char_icon_fixed_width?pCharIcon2n.image.width:pCharIcon2n.image.height);
              pCharIcon2n.scaleY = pCharIcon2n.scaleX;

              pCharIcon2.addChild(pCharIcon2n);
            }
            oldChar2 = pChar2;
          })
            .to({alpha:1},500, createjs.Ease.quintOut).call(function() {animating = false;});
        }

        if (oldTeammateChar1 != teammateChar1 || tCharIcon1.alpha == 0) {
          animating = true;
          var tCharIcon1n = new createjs.Bitmap("images/smash_ultimate/" + teammateChar1 + ".png");

          createjs.Tween.get(tCharIcon1).to({alpha:0},500, createjs.Ease.quintIn).call(function() {
            tCharIcon1.removeAllChildren();

            if (tCharIcon1n.image.height != 0) { //image exists
              tCharIcon1n.scaleX = char_icon_size / (char_icon_fixed_width?tCharIcon1n.image.width:tCharIcon1n.image.height);
              tCharIcon1n.scaleY = tCharIcon1n.scaleX;

              tCharIcon1.addChild(tCharIcon1n);
            }
            oldTeammateChar1 = teammateChar1;
          })
            .to({alpha:1},500, createjs.Ease.quintOut).call(function() {animating = false;});
        }

        if (oldTeammateChar2 != teammateChar2 || tCharIcon2.alpha == 0) {
          animating = true;
          var tCharIcon2n = new createjs.Bitmap("images/smash_ultimate/" + teammateChar2 + ".png");

          createjs.Tween.get(tCharIcon2).to({alpha:0},500, createjs.Ease.quintIn).call(function() {
            tCharIcon2.removeAllChildren();

            if (tCharIcon2n.image.height != 0) { //image exists
              tCharIcon2n.scaleX = char_icon_size / (char_icon_fixed_width?tCharIcon2n.image.width:tCharIcon2n.image.height);
              tCharIcon2n.scaleY = tCharIcon2n.scaleX;

              tCharIcon2.addChild(tCharIcon2n);
            }
            oldTeammateChar2 = teammateChar2;
          })
            .to({alpha:1},500, createjs.Ease.quintOut).call(function() {animating = false;});
        }

        if (roundt.text != round) {
          animating = true;
          createjs.Tween.get(roundt).to({alpha:0},500, createjs.Ease.quintIn).call(function() {roundt.text = round;})
            .to({alpha:1},500, createjs.Ease.quintOut).call(function() {animating = false;});
        }

        doUpdate = false;
      }
    </script>
  </head>
  <body onLoad="init()" style="margin:0px;">
    <canvas id="myCanvas" width="1920" height="1080">
      canvas
    </canvas>
  </body>
</html>
